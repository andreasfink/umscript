# File: Makefile
# Project "umscript"
# (c) 2002 -2014 SMSRelay AG
# Create: Andreas Fink (afink@smsrelay.com)
#
#

CC=@CC@
CFLAGS=@CFLAGS@
CONFIGURATION=Release
CFLAGS=-pg -g -O0 -fPIC -fobjc-runtime=gnustep -fobjc-arc -fpascal-strings -fasm-blocks -fstrict-aliasing -fdiagnostics-show-note-include-stack -Wmissing-prototypes -I.  -Isrc/asn  -Isrc -I/usr/include/postgresql -I/usr/include/mysql -DLINUX=1 -DSCTP_IN_KERNEL=1 -D_BSD_SOURCE -I/usr/include/libxml2 -DCONFIGURATION=${CONFIGURATION} -IClasses/UniversalUtilities
LDFLAGS=@LDFLAGS@

LIB=libumscript.so
PKGCONFIGFILE=umscript.pc

MFILES = $(wildcard umsccript/*.m) language/_generated_umscript.l.m language/_generated_umscript.y.m
HFILES = version.h $(wildcard umsccript/*.h)
MOFILES  = $(MFILES:.m=.m.o)
OFILES = $(MOFILES)

INCLUDEDIRS = -I umscript -I language
DEBUG_RELEASE = -DCONFIGURATION_${CONFIGURATION}=1 -DCONFIGURATION=${CONFIGURATION}




${LIB}: ${OFILES}
	./make_version
	${CC} -shared -o ${LIB}  ${LDFLAGS} ${OFILES} ${LIBS} ${STATIC_LIBS}

install: ${LIB}
	-mkdir -p ${DESTDIR}/usr/local/lib/pkgconfig
	-install -b -g root -o root -m 644 ${LIB} ${DESTDIR}/usr/local/lib/
	-install -b -g root -o root -m 644 ${PKGCONFIGFILE} ${DESTDIR}/usr/local/lib/pkgconfig/
	-mkdir -p ${DESTDIR}/usr/local/include/umscript
	cp umscript/*.h ${DESTDIR}/usr/local/include/umscript


#/usr/local/bin/flex --outfile language/_generated_umscript.l.m language/umscript.l
#/usr/local/bin/bison  --defines=language/_generated_umscript.y.h --output-file language/_generated_umscript.y.m language/umscript.y --warnings=none


language/_generated_umscript.l.m:	language/umscript.l
	/usr/local/bin/flex --outfile language/_generated_umscript.l.m language/umscript.l

_generated_umscript.y.m:	language/umscript.y
	usr/local/bin/bison  --defines=language/_generated_umscript.y.h --output-file language/_generated_umscript.y.m language/umscript.y --warnings=none

clean:
	-mv ${LIB} ${LIB}.old
	-rm -f $(MOFILES)

.SUFFIXES: .m.o .o .m .c

%.m.o:	%.m
	${CC} -c ${CFLAGS} ${DEBUG_RELEASE} -x objective-c $<  ${DEBUG_RELEASE} ${INCLUDEDIRS} -o $@


